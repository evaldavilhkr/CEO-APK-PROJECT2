<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>APK BY CEO APON - ইনভেন্টরি ও পেমেন্ট হিস্ট্রি</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        th { background-color: #10b981 !important; color: white !important; }
        .container-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body class="p-4 sm:p-8">
    <div id="app-container" class="max-w-6xl mx-auto bg-white p-4 sm:p-6 rounded-xl container-shadow">
        <header class="text-center pb-4 border-b border-gray-200 mb-6">
            <h1 class="text-3xl font-extrabold text-emerald-600">APK BY CEO APON</h1>
            <p class="text-sm text-gray-500">ইনভেন্টরি এবং পার্মানেন্ট লেনদেন রেকর্ড</p>
        </header>

        <div id="message-box" class="hidden p-3 mb-4 rounded-lg font-semibold transition-all"></div>

        <div id="login-form" class="max-w-sm mx-auto p-6 bg-gray-50 rounded-lg shadow-inner">
            <label class="block text-sm font-medium text-gray-700 mb-2">পাসওয়ার্ড:</label>
            <input type="password" id="password" placeholder="পাসওয়ার্ড লিখুন" class="w-full p-3 border rounded-lg mb-4 outline-none focus:ring-2 focus:ring-emerald-500">
            <button id="login-btn" class="w-full p-3 bg-emerald-500 text-white font-bold rounded-lg hover:bg-emerald-600 transition">লগইন</button>
        </div>

        <div id="app-content" class="hidden">
            <section class="mb-6">
                <input type="text" id="search-input" placeholder="পণ্য বা সাপ্লাইয়ার দিয়ে সার্চ করুন..." 
                       class="w-full p-3 border-2 border-emerald-100 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 outline-none transition">
            </section>

            <section class="mb-8 p-4 border border-emerald-200 rounded-xl bg-emerald-50/30">
                <h2 class="text-xl font-semibold text-emerald-700 mb-4 border-b pb-2">নতুন পণ্য যোগ করুন</h2>
                <form id="product-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="product-name" placeholder="পণ্যের নাম" required class="p-2 border rounded-lg outline-none focus:ring-1 focus:ring-emerald-400">
                        <input type="text" id="supplier-name" placeholder="সাপ্লাইয়ার নাম" class="p-2 border rounded-lg outline-none focus:ring-1 focus:ring-emerald-400">
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <input type="number" id="product-quantity" placeholder="পরিমাণ" required min="1" class="p-2 border rounded-lg outline-none focus:ring-1 focus:ring-emerald-400">
                        <input type="number" id="product-price" placeholder="ইউনিট মূল্য" required class="p-2 border rounded-lg outline-none focus:ring-1 focus:ring-emerald-400">
                        <input type="number" id="payment" placeholder="পেমেন্ট" required class="p-2 border rounded-lg outline-none focus:ring-1 focus:ring-emerald-400">
                    </div>
                    <button type="submit" class="w-full p-3 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition">পণ্য যোগ করুন</button>
                </form>
            </section>

            <section class="mb-8">
                <h2 class="text-xl font-semibold text-emerald-700 mb-4">পণ্যের তালিকা</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-emerald-500">
                            <tr>
                                <th class="px-4 py-3 text-left">পণ্য / সাপ্লাইয়ার</th>
                                <th class="px-4 py-3 text-center">পরিমাণ</th>
                                <th class="px-4 py-3 text-center">মূল্য</th>
                                <th class="px-4 py-3 text-center">মোট খরচ</th>
                                <th class="px-4 py-3 text-center">পেমেন্ট</th>
                                <th class="px-4 py-3 text-center">বাকি</th>
                                <th class="px-4 py-3 text-center">তারিখ</th>
                                <th class="px-4 py-3 text-center">অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody id="product-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>

            <section>
                <h2 class="text-xl font-semibold text-blue-700 mb-4 border-b-2 border-blue-100 pb-2">পেমেন্ট হিস্ট্রি (ডাটাবেস রেকর্ড)</h2>
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-slate-700 text-white">
                            <tr>
                                <th class="px-4 py-2 text-left !bg-slate-600">পণ্যের নাম</th>
                                <th class="px-4 py-2 text-left !bg-slate-600">পেমেন্টের পরিমাণ</th>
                                <th class="px-4 py-2 text-left !bg-slate-600">তারিখ ও সময়</th>
                            </tr>
                        </thead>
                        <tbody id="payment-history-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAWq4Lkt0GCtjcZGvZijI2OO7-6Hu5molM",
            authDomain: "note-by-ceo-5b42a.firebaseapp.com",
            databaseURL: "https://note-by-ceo-5b42a-default-rtdb.firebaseio.com",
            projectId: "note-by-ceo-5b42a",
            storageBucket: "note-by-ceo-5b42a.firebasestorage.app",
            messagingSenderId: "442049744344",
            appId: "1:442049744344:web:8be3da17ede606bb6df6ad",
            measurementId: "G-2V9Y6CEYZE"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const productsRef = database.ref('products');
        const paymentHistoryRef = database.ref('paymentHistory');

        const SECRET_PASSWORD = "CEO1212";
        let products = [];

        // DOM Elements
        const loginForm = document.getElementById('login-form');
        const appContent = document.getElementById('app-content');
        const tableBody = document.getElementById('product-table-body');
        const historyBody = document.getElementById('payment-history-body');
        const messageBox = document.getElementById('message-box');

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = `p-3 mb-4 rounded-lg font-semibold transition-all ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 4000);
        }

        // লগইন লজিক
        document.getElementById('login-btn').onclick = () => {
            if (document.getElementById('password').value === SECRET_PASSWORD) {
                loginForm.classList.add('hidden');
                appContent.classList.remove('hidden');
                showMessage("লগইন সফল হয়েছে!", "success");
            } else {
                alert("ভুল পাসওয়ার্ড! সঠিক পাসওয়ার্ড দিন।");
            }
        };

        // সার্চ লজিক
        document.getElementById('search-input').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
            });
        };

        // পণ্য যোগ করার ফাংশন
        document.getElementById('product-form').onsubmit = (e) => {
            e.preventDefault();
            const pName = document.getElementById('product-name').value;
            const q = parseInt(document.getElementById('product-quantity').value);
            const pr = parseFloat(document.getElementById('product-price').value);
            const pay = parseFloat(document.getElementById('payment').value);
            const total = q + pr; // আপনার অরিজিনাল লজিক: quantity + price

            const newProduct = {
                productName: pName,
                supplierName: document.getElementById('supplier-name').value || 'N/A',
                productQuantity: q,
                productPrice: pr,
                totalCost: total,
                payment: pay,
                due: total - pay,
                purchaseDate: new Date().toLocaleString('bn-BD')
            };

            productsRef.push(newProduct).then(() => {
                showMessage(`"${pName}" সফলভাবে যোগ করা হয়েছে।`);
                e.target.reset();
            });
        };

        // পণ্যের তালিকা রিয়েল-টাইম লোড
        productsRef.on('value', (snap) => {
            tableBody.innerHTML = ''; products = [];
            snap.forEach(child => {
                let p = child.val(); p.key = child.key;
                products.push(p);
                tableBody.insertAdjacentHTML('afterbegin', `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3"><div class="font-bold text-gray-800">${p.productName}</div><div class="text-xs text-gray-400">${p.supplierName}</div></td>
                        <td class="px-4 py-3 text-center">${p.productQuantity}</td>
                        <td class="px-4 py-3 text-center">৳${p.productPrice.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center font-bold text-emerald-600">৳${p.totalCost.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center text-emerald-500 font-semibold">৳${p.payment.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center font-bold ${p.due > 0 ? 'text-red-500' : 'text-emerald-500'}">৳${p.due.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center text-xs text-gray-500">${p.purchaseDate}</td>
                        <td class="px-4 py-3 flex flex-col gap-1">
                            <button onclick="openPaymentModal('${p.key}')" class="bg-indigo-500 text-white text-[10px] py-1 px-2 rounded hover:bg-indigo-600 ${p.due <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${p.due <= 0 ? 'disabled' : ''}>পেমেন্ট</button>
                            <button onclick="deleteProduct('${p.key}')" class="bg-red-500 text-white text-[10px] py-1 px-2 rounded hover:bg-red-600">ডিলিট</button>
                        </td>
                    </tr>
                `);
            });
        });

        // পেমেন্ট হিস্ট্রি রিয়েল-টাইম লোড (পার্মানেন্ট)
        paymentHistoryRef.on('value', (snapshot) => {
            historyBody.innerHTML = '';
            if(!snapshot.exists()) {
                historyBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400">কোনো হিস্ট্রি নেই</td></tr>';
                return;
            }
            snapshot.forEach((child) => {
                const data = child.val();
                historyBody.insertAdjacentHTML('afterbegin', `
                    <tr class="border-b">
                        <td class="px-4 py-2 font-medium">${data.productName}</td>
                        <td class="px-4 py-2 text-emerald-600 font-bold">৳ ${data.paymentAmount.toFixed(2)}</td>
                        <td class="px-4 py-2 text-xs text-gray-500">${data.paymentDate}</td>
                    </tr>
                `);
            });
        });

        // পেমেন্ট মডাল লজিক
        let modal = document.createElement('div');
        modal.className = "hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 transition-all";
        document.body.appendChild(modal);

        window.openPaymentModal = (key) => {
            const p = products.find(x => x.key === key);
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-xl w-full max-w-xs shadow-2xl">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${p.productName}</h3>
                    <p class="text-sm text-red-500 mb-4 font-semibold">বর্তমান বাকি: ৳${p.due.toFixed(2)}</p>
                    <input type="number" id="pay-amt" class="w-full border-2 border-emerald-100 p-2 rounded-lg mb-4 outline-none focus:border-emerald-500" placeholder="টাকার পরিমাণ লিখুন">
                    <div class="flex gap-2">
                        <button onclick="modal.classList.add('hidden')" class="flex-1 bg-gray-200 p-2 rounded-lg font-semibold">বাতিল</button>
                        <button onclick="makePayment('${key}')" class="flex-1 bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600">পেমেন্ট নিশ্চিত</button>
                    </div>
                </div>`;
            modal.classList.remove('hidden');
        };

        // পেমেন্ট প্রসেসিং এবং হিস্ট্রি আপডেট
        window.makePayment = (key) => {
            const amt = parseFloat(document.getElementById('pay-amt').value);
            const p = products.find(x => x.key === key);
            
            if(amt > 0 && amt <= p.due) {
                // ১. প্রোডাক্টের বাকি টাকা আপডেট
                productsRef.child(key).update({
                    payment: p.payment + amt,
                    due: p.due - amt,
                    lastPaymentDate: new Date().toLocaleString('bn-BD')
                }).then(() => {
                    // ২. পেমেন্ট হিস্ট্রি কালেকশনে নতুন রেকর্ড যোগ করা
                    const historyData = {
                        productName: p.productName,
                        paymentAmount: amt,
                        paymentDate: new Date().toLocaleString('bn-BD')
                    };
                    paymentHistoryRef.push(historyData);
                    
                    modal.classList.add('hidden');
                    showMessage(`৳${amt} পেমেন্ট সফল হয়েছে!`);
                });
            } else {
                alert("সঠিক পরিমাণ দিন! বাকির চেয়ে বেশি পেমেন্ট করা যাবে না।");
            }
        };

        // ডিলিট ফাংশন
        window.deleteProduct = (key) => {
            if(confirm("আপনি কি নিশ্চিতভাবে এই লেনদেনটি ডিলিট করতে চান?")) {
                productsRef.child(key).remove().then(() => showMessage("লেনদেনটি ডিলিট করা হয়েছে।", "error"));
            }
        };
    </script>
</body>
</html>
